<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hub Virgem ‚Ä¢ Dual.Infodose</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#050510" id="metaThemeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png">
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon-192.png">

 
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsQR (Non-module script) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <style>
        :root {
            --color-bg: #050b14;
            --color-nebula-1: #1a103c;
            --color-nebula-2: #0f2045;
            --color-accent: #4f8ff7;
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
            --transition-slow: 1.2s cubic-bezier(0.16, 1, 0.3, 1);
            --transition-fast: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--color-bg);
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
            color: white;
            height: 100vh;
            width: 100vw;
        }

        @supports(min-height:100dvh){
          body{height:100dvh;}
        }

        /* Nebula Background */
        #nebula-layer {
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(circle at 50% 50%, var(--color-nebula-1) 0%, transparent 60%),
                radial-gradient(circle at 80% 20%, var(--color-nebula-2) 0%, transparent 50%),
                radial-gradient(circle at 20% 80%, #0d1b2a 0%, transparent 50%);
            opacity: 0.6;
            z-index: 0;
            animation: breathe 12s infinite ease-in-out;
        }

        @keyframes breathe {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* Canvas Container */
        #canvas-container {
            position: absolute;
            inset: 0;
            z-index: 1;
            cursor: pointer;
            transition: filter var(--transition-slow);
        }

        body.modal-open #canvas-container {
            filter: blur(12px) brightness(0.6);
            pointer-events: none;
        }

        /* UI Layer */
        #ui-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border-radius: 24px;
            pointer-events: auto;
        }

        /* Input Modal */
        #input-modal {
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            transition: opacity var(--transition-fast), transform var(--transition-fast);
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            display: none;
        }

        #input-modal.active {
            opacity: 1;
            transform: scale(1) translateY(0);
            display: block;
        }

        /* App Stack */
        #app-stack {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity var(--transition-fast), transform var(--transition-fast);
            width: 100%;
            height: 100%;
            padding: 2rem 1rem;
            box-sizing: border-box;
            overflow-y: auto;
            display: none;
            pointer-events: auto;
            max-width: 600px;
        }

        #app-stack.active {
            opacity: 1;
            transform: translateY(0);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Inputs & Buttons */
        .nebula-input {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            margin-bottom: 1rem;
        }

        .nebula-input:focus {
            border-color: var(--color-accent);
            box-shadow: 0 0 12px rgba(79, 143, 247, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .btn-primary:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.4);
            transform: translateY(-1px);
        }

        /* Camera View */
        #scanner-container {
            position: relative;
            width: 100%;
            height: 250px;
            background: black;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
            display: none;
        }

        #video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .fade-enter { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* App Item */
        .app-card {
            background: rgba(13, 27, 42, 0.6);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 1.2rem 1.4rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform 0.16s, background 0.16s, box-shadow 0.16s;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }

        .app-card:hover {
            background: rgba(255,255,255,0.06);
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 18px 40px rgba(0,0,0,0.5);
        }

        .app-icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: radial-gradient(circle at 0 0, rgba(255,255,255,0.25), rgba(13,27,42,1));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-accent);
            font-size: 1.5rem;
            overflow:hidden;
            flex-shrink:0;
        }

        .app-icon img{
          width:100%;
          height:100%;
          object-fit:cover;
          border-radius:14px;
          display:block;
        }

        .scroll-hide::-webkit-scrollbar { display: none; }
        .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; }

        #reset-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.5;
            font-size: 0.8rem;
            z-index: 50;
            cursor: pointer;
        }

        /* üî• Viewer Stack (iframe overlay) */
        .viewer {
            position: fixed;
            inset: 0;
            display: none;
            align-items: stretch;
            justify-content: center;
            background: rgba(1, 2, 10, 0.92);
            z-index: 40;
        }

        .viewer.show {
            display: flex;
        }

        .viewer-frame {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(145deg, var(--color-bg), #050512);
            border-radius: 0;
            border: 1px solid var(--glass-border);
            box-shadow: 0 24px 60px rgba(0,0,0,.9);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .viewer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            background: radial-gradient(circle at top, rgba(79,143,247,0.24), transparent 55%);
        }

        .viewer-header-left,
        .viewer-header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .viewer-title {
            font-size: 0.9rem;
            font-weight: 400;
            opacity: 0.85;
        }

        .viewer-btn {
            border: none;
            padding: 0.4rem;
            border-radius: 999px;
            background: rgba(0,0,0,0.4);
            color: #fff;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, transform 0.1s;
        }

        .viewer-btn:hover {
            background: rgba(255,255,255,0.12);
            transform: translateY(-1px);
        }

        .viewer-body {
            flex: 1;
            position: relative;
        }

        .viewer-body iframe {
            width: 100%;
            height: 100%;
            border: 0;
            background: #000;
        }
    </style>
</head>
<body>

    <!-- Background -->
    <div id="nebula-layer"></div>

    <!-- 3D Scene -->
    <div id="canvas-container"></div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        
        <!-- 1. Input Modal -->
        <div id="input-modal" class="glass-panel">
            <div class="mb-4">
                <i data-lucide="sparkles" class="w-8 h-8 mx-auto text-blue-300 mb-2"></i>
                <h2 class="text-xl font-light text-blue-100">Acesso Nebular</h2>
                <p class="text-xs text-blue-300/60 mt-1">Cole sua ChavePic ou URL JSON</p>
            </div>

            <div id="scanner-container">
                <video id="video-feed" playsinline></video>
                <div class="absolute inset-0 border-2 border-blue-400/30 animate-pulse rounded-xl pointer-events-none"></div>
            </div>

            <input type="text" id="access-key" class="nebula-input" placeholder="Cole a chave ou URL aqui..." autocomplete="off">
            
            <div class="flex gap-3">
                <button id="btn-scan" class="btn-primary" style="width: auto;">
                    <i data-lucide="qr-code"></i>
                </button>
                <button id="btn-connect" class="btn-primary flex-1">
                    Conectar
                </button>
            </div>
            <p id="status-msg" class="mt-3 text-xs text-red-400 min-h-[1rem]"></p>
        </div>

        <!-- 2. Apps Stack -->
        <div id="app-stack" class="scroll-hide">
            <div class="w-full flex justify-between items-center mb-6 px-2">
                <h1 class="text-2xl font-light tracking-wide text-white">
                    Meus Apps
                </h1>
                <div class="flex items-center gap-2">
                    <!-- üîô Bot√£o de Voltar topo direita -->
                    <button id="btn-back" class="p-2 rounded-full hover:bg-white/10 transition">
                        <i data-lucide="arrow-left" class="w-5 h-5 text-white/80"></i>
                    </button>
                    <button id="btn-logout" class="p-2 rounded-full hover:bg-white/10 transition">
                        <i data-lucide="log-out" class="w-5 h-5 text-red-300"></i>
                    </button>
                </div>
            </div>
            
            <div id="apps-container" class="flex flex-col gap-4 pb-20">
                <!-- Apps ser√£o injetados aqui -->
            </div>
        </div>

    </div>

    <!-- üî• Viewer Stack (App em iframe) -->
    <div id="app-viewer" class="viewer">
        <div class="viewer-frame">
            <div class="viewer-header">
                <div class="viewer-header-left">
                    <button id="viewer-back" class="viewer-btn" title="Voltar">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <span id="viewer-title" class="viewer-title">App</span>
                </div>
                <div class="viewer-header-right">
                    <button id="viewer-external" class="viewer-btn" title="Abrir em nova aba">
                        <i data-lucide="external-link"></i>
                    </button>
                    <button id="viewer-close" class="viewer-btn" title="Fechar">
                        <i data-lucide="x"></i>
                    </button>
                </div>
            </div>
            <div class="viewer-body">
                <iframe id="viewer-iframe" src=""></iframe>
            </div>
        </div>
    </div>

    <div id="reset-btn" class="hidden text-white/30 hover:text-white transition">
        Resetar Ritual
    </div>

    <!-- Module Script -->
    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

        // --- CONSTANTS & STATE ---
        const STATE = {
            IDLE: 'idle',
            INPUT: 'input',
            UNLOCKED: 'unlocked'
        };

        let currentState = STATE.IDLE;
        let scannerActive = false;
        let videoStream = null;
        let currentAppUrl = null;
        
        // --- DOM ELEMENTS ---
        const dom = {
            body: document.body,
            canvasContainer: document.getElementById('canvas-container'),
            inputModal: document.getElementById('input-modal'),
            appStack: document.getElementById('app-stack'),
            inputKey: document.getElementById('access-key'),
            btnConnect: document.getElementById('btn-connect'),
            btnScan: document.getElementById('btn-scan'),
            scannerContainer: document.getElementById('scanner-container'),
            video: document.getElementById('video-feed'),
            status: document.getElementById('status-msg'),
            appsContainer: document.getElementById('apps-container'),
            btnLogout: document.getElementById('btn-logout'),
            btnBack: document.getElementById('btn-back'),
            resetBtn: document.getElementById('reset-btn'),
            // Viewer
            viewer: document.getElementById('app-viewer'),
            viewerIframe: document.getElementById('viewer-iframe'),
            viewerTitle: document.getElementById('viewer-title'),
            viewerBack: document.getElementById('viewer-back'),
            viewerClose: document.getElementById('viewer-close'),
            viewerExternal: document.getElementById('viewer-external')
        };

        // --- THREE.JS SPHERE ENGINE ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050b14, 0.02);

        const camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
        dom.canvasContainer.appendChild(renderer.domElement);

        // Core Sphere
        const geometry = new THREE.IcosahedronGeometry(1.5, 4);
        const material = new THREE.MeshBasicMaterial({ 
            color: 0x4f8ff7, 
            wireframe: true, 
            transparent: true, 
            opacity: 0.15 
        });
        const sphere = new THREE.Mesh(geometry, material);
        scene.add(sphere);

        // Glow Shell
        const glowGeo = new THREE.IcosahedronGeometry(1.6, 2);
        const glowMat = new THREE.MeshBasicMaterial({
            color: 0x8a4fff,
            wireframe: true,
            transparent: true,
            opacity: 0.05,
            side: THREE.BackSide
        });
        const glowSphere = new THREE.Mesh(glowGeo, glowMat);
        scene.add(glowSphere);

        // Particles
        const particlesGeo = new THREE.BufferGeometry();
        const particlesCount = 200;
        const posArray = new Float32Array(particlesCount * 3);
        for(let i = 0; i < particlesCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 10;
        }
        particlesGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const particlesMat = new THREE.PointsMaterial({
            size: 0.02,
            color: 0xffffff,
            transparent: true,
            opacity: 0.4
        });
        const particlesMesh = new THREE.Points(particlesGeo, particlesMat);
        scene.add(particlesMesh);

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0x4f8ff7, 2, 100);
        pointLight.position.set(2, 2, 5);
        scene.add(pointLight);

        // Animation Loop
        let time = 0;
        function animate() {
            requestAnimationFrame(animate);
            time += 0.005;

            sphere.rotation.y += 0.002;
            sphere.rotation.x += 0.001;
            glowSphere.rotation.y -= 0.001;
            particlesMesh.rotation.y = time * 0.05;

            const pulse = 1 + Math.sin(time * 2) * 0.05;
            sphere.scale.set(pulse, pulse, pulse);
            
            const hue = (Math.sin(time * 0.5) + 1) * 0.1 + 0.55;
            material.color.setHSL(hue, 0.8, 0.6);

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- INTERACTION LOGIC ---

        dom.canvasContainer.addEventListener('click', () => {
            if (currentState === STATE.IDLE) {
                transitionTo(STATE.INPUT);
            }
        });

        function transitionTo(newState) {
            currentState = newState;
            
            dom.body.classList.remove('modal-open');
            dom.inputModal.classList.remove('active');
            dom.appStack.classList.remove('active');
            dom.canvasContainer.style.display = 'block';

            if (newState === STATE.INPUT) {
                dom.body.classList.add('modal-open');
                dom.inputModal.classList.add('active');
                setTimeout(() => dom.inputKey.focus(), 100);
                dom.resetBtn.classList.remove('hidden');
            } 
            else if (newState === STATE.UNLOCKED) {
                dom.body.classList.add('modal-open');
                dom.appStack.classList.add('active');
                dom.resetBtn.classList.remove('hidden');
            }
            else if (newState === STATE.IDLE) {
                dom.resetBtn.classList.add('hidden');
                stopScanner();
            }
        }

        dom.resetBtn.addEventListener('click', () => {
            logout();
        });

        // --- APP LOGIC & FETCHING ---

        const STORAGE_KEY = 'nebula_auth';

        function checkSession() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    const session = JSON.parse(stored);
                    const now = Date.now();
                    if (now - session.timestamp < 24 * 60 * 60 * 1000) {
                        loadApps(session.data);
                        transitionTo(STATE.UNLOCKED);
                        return;
                    } else {
                        localStorage.removeItem(STORAGE_KEY);
                    }
                } catch (e) {
                    console.error("Session parse error", e);
                    localStorage.removeItem(STORAGE_KEY);
                }
            }
            transitionTo(STATE.IDLE);
        }

        async function handleConnect() {
            const key = dom.inputKey.value.trim();
            if (!key) {
                showStatus("Por favor, insira uma chave ou URL.", true);
                return;
            }

            dom.btnConnect.innerHTML = '<i class="animate-spin" data-lucide="loader"></i> Conectando...';
            lucide.createIcons();

            try {
                let appData = null;

                if (key.startsWith('http')) {
                    const response = await fetch(key);
                    if (!response.ok) throw new Error('Falha ao carregar JSON');
                    appData = await response.json();
                } 
                else if (key === '369' || key.toLowerCase() === 'demo') {
                    appData = getDemoData();
                    await new Promise(r => setTimeout(r, 600)); 
                }
                else {
                    throw new Error('Chave inv√°lida ou expirada.');
                }

                if (appData) {
                    saveSession(appData);
                    loadApps(appData);
                    transitionTo(STATE.UNLOCKED);
                    triggerSuccessEffect();
                }

            } catch (error) {
                showStatus(error.message, true);
            } finally {
                dom.btnConnect.innerText = 'Conectar';
            }
        }

        function saveSession(data) {
            const session = {
                timestamp: Date.now(),
                data
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(session));
        }

        function logout() {
            localStorage.removeItem(STORAGE_KEY);
            dom.appsContainer.innerHTML = '';
            dom.inputKey.value = '';
            showStatus('', false);
            closeViewer();
            transitionTo(STATE.IDLE);
        }

        // üîÅ AQUI: usando teus apps reais como DEMO 369
        function getDemoData() {
            return {
                apps: [
                  {
                    "key": "ticos",
                    "title": "üóíÔ∏è Pr√°ticas ‚Äî NR10/NR35 (Ultra)",
                    "desc": "PWA offline com dashboard, lembrete e relatos com √°udio.",
                    "icon": "icons/icon-192.png",
                    "url": "./PWA_TICO_Ultra/index.html"
                  },
                  {
                    "key": "app2",
                    "title": "üè† Regualiza√ß√£o",
                    "desc": "Regularize seu im√≥vel.",
                    "icon": "icons/icon-192.png",
                    "url": "./apps/lp-reg-10-ok-R-5.html"
                  },
                  {
                    "key": "Contratos",
                    "title": "üìë Gerar Contrato",
                    "desc": "Gere or√ßamentos.",
                    "icon": "icons/icon-192.png",
                    "url": "./apps/JHBARROS-contratos.html"
                  },
                  {
                    "key": "d0x",
                    "title": "üìú infoD0X",
                    "desc": "Livro vivo.",
                    "icon": "icons/icon-192.png",
                    "url": "./apps/index_final_cards_nossolar.html"
                  },
                  {
                    "key": "dual-editor",
                    "title": "‚úèÔ∏è Dual Editor ‚Ä¢ Kodux",
                    "desc": "Editor vivo para c√≥digos, prompts e HTML Dual.",
                    "icon": "icons/icon-192.png",
                    "url": "https://kodux78k.github.io/Dual-Editor/"
                  },
                  {
                    "key": "unouno-oraculo",
                    "title": "üåÄ UnoUno ‚Ä¢ Or√°culo Dual",
                    "desc": "Or√°culo simb√≥lico estilo HUB Uno, experimental.",
                    "icon": "icons/icon-192.png",
                    "url": "https://kodux78k.github.io/Unouno-/index.html"
                  },
                  {
                    "key": "info-doc",
                    "title": "üìö Info-Doc ‚Ä¢ Livro Vivo",
                    "desc": "Leitor/organizador de documentos e livros vivos Infodose.",
                    "icon": "icons/icon-192.png",
                    "url": "https://kodux78k.github.io/info-Doc/index.html"
                  },
                  {
                    "key": "nossolar-dual",
                    "title": "‚òÄÔ∏è Nos.S¬∞lar ‚Äì dual.infodose",
                    "desc": "Painel solar simb√≥lico com cards e rede Nos.S¬∞lar.",
                    "icon": "icons/icon-192.png",
                    "url": "https://kodux78k.github.io/NosSolar-dualInfodose/"
                  },
                  {
                    "key": "dual-app",
                    "title": "üåê Dual App ‚Ä¢ Hub",
                    "desc": "App central Dual para experimentos de interface e fluxo.",
                    "icon": "icons/icon-192.png",
                    "url": "https://kodux78k.github.io/dual-app/index.html"
                  },
                  {
                    "key": "dual-splash",
                    "title": "‚ú® A.Dual.Infodose ‚Ä¢ Splash",
                    "desc": "Tela de abertura / splash ritual da A.Dual.Infodose.",
                    "icon": "icons/icon-192.png",
                    "url": "https://kodux78k.github.io/A.Dual.Infodose/splash.html"
                  }
                ]
            };
        }

        function loadApps(json) {
            dom.appsContainer.innerHTML = '';
            const apps = json.apps || [];

            if (!apps.length) {
                dom.appsContainer.innerHTML = '<div class="text-center text-white/50">Nenhum app encontrado para esta chave.</div>';
                return;
            }

            apps.forEach((app, index) => {
                const delay = index * 80;
                const el = document.createElement('a');
                el.href = app.url || '#';
                el.className = 'app-card fade-enter';
                el.style.animationDelay = `${delay}ms`;

                const icon = app.icon || 'box';
                const isImgIcon =
                  icon.includes('/') ||
                  icon.endsWith('.png') ||
                  icon.endsWith('.jpg') ||
                  icon.endsWith('.jpeg') ||
                  icon.endsWith('.webp') ||
                  icon.endsWith('.svg');

                const title = app.title || 'App';
                const desc = app.desc || 'Aplica√ß√£o conectada';

                el.innerHTML = `
                    <div class="app-icon">
                      ${
                        isImgIcon
                          ? `<img src="${icon}" alt="icon">`
                          : `<i data-lucide="${icon}" class="${app.color || 'text-blue-400'} w-6 h-6"></i>`
                      }
                    </div>
                    <div class="flex-1">
                        <h3 class="text-[15px] font-medium text-white line-clamp-1">${title}</h3>
                        <p class="text-[12px] text-white/55 mt-[2px] line-clamp-2">${desc}</p>
                    </div>
                    ${
                      app.type === 'premium'
                        ? '<i data-lucide="lock" class="w-4 h-4 text-yellow-500/60"></i>'
                        : '<i data-lucide="chevron-right" class="w-5 h-5 text-white/24"></i>'
                    }
                `;

                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (!app.url) return;
                    if (app.type === 'premium' && !app.url) {
                        alert(`Simula√ß√£o: Conectando via Webhook seguro para ${title}...`);
                        return;
                    }
                    openAppInViewer(app);
                });

                dom.appsContainer.appendChild(el);
            });

            lucide.createIcons();
        }

        function triggerSuccessEffect() {
            const originalColor = material.color.getHex();
            material.color.setHex(0xffffff);
            setTimeout(() => {
                material.color.setHex(originalColor);
            }, 300);
        }

        function showStatus(msg, isError) {
            dom.status.textContent = msg;
            dom.status.className = isError
              ? 'mt-3 text-xs text-red-400 min-h-[1rem]'
              : 'mt-3 text-xs text-green-400 min-h-[1rem]';
        }

        // --- QR CODE SCANNER ---

        dom.btnScan.addEventListener('click', toggleScanner);

        function toggleScanner() {
            if (scannerActive) {
                stopScanner();
            } else {
                startScanner();
            }
        }

        function startScanner() {
            dom.scannerContainer.style.display = 'block';
            scannerActive = true;
            dom.btnScan.innerHTML = '<i data-lucide="x"></i>';
            lucide.createIcons();

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    videoStream = stream;
                    dom.video.srcObject = stream;
                    dom.video.setAttribute("playsinline", true);
                    dom.video.play();
                    requestAnimationFrame(tickScanner);
                })
                .catch(err => {
                    console.error(err);
                    showStatus("C√¢mera n√£o acess√≠vel.", true);
                    stopScanner();
                });
        }

        function stopScanner() {
            scannerActive = false;
            dom.scannerContainer.style.display = 'none';
            dom.btnScan.innerHTML = '<i data-lucide="qr-code"></i>';
            lucide.createIcons();
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
        }

        function tickScanner() {
            if (!scannerActive) return;
            if (dom.video.readyState === dom.video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement("canvas");
                canvas.width = dom.video.videoWidth;
                canvas.height = dom.video.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(dom.video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                if (window.jsQR) {
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    if (code) {
                        dom.inputKey.value = code.data;
                        stopScanner();
                        handleConnect();
                    }
                }
            }
            requestAnimationFrame(tickScanner);
        }

        // --- VIEWER STACK LOGIC ---

        function openAppInViewer(app) {
            if (!app.url) return;
            currentAppUrl = app.url;
            dom.viewerIframe.src = app.url;
            dom.viewerTitle.textContent = app.title || 'App';
            dom.viewer.classList.add('show');
            dom.body.classList.add('modal-open');

            if (dom.viewerExternal) {
                dom.viewerExternal.onclick = () => {
                    if (currentAppUrl) {
                        window.open(currentAppUrl, '_blank', 'noopener,noreferrer');
                    }
                };
            }
            lucide.createIcons();
        }

        function closeViewer() {
            dom.viewer.classList.remove('show');
            dom.viewerIframe.src = 'about:blank';
        }

        function viewerGoBack() {
            try {
                const frameWindow = dom.viewerIframe.contentWindow;
                if (frameWindow && frameWindow.history && frameWindow.history.length > 1) {
                    frameWindow.history.back();
                    return;
                }
            } catch (e) {
                // Cross-origin, ignora
            }
            closeViewer();
        }

        dom.viewerBack.addEventListener('click', viewerGoBack);
        dom.viewerClose.addEventListener('click', closeViewer);

        // --- INITIALIZATION ---
        dom.btnConnect.addEventListener('click', handleConnect);
        dom.btnLogout.addEventListener('click', logout);
        dom.inputKey.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleConnect();
        });

        dom.btnBack.addEventListener('click', () => {
            dom.appsContainer.scrollTop = 0;
            transitionTo(STATE.INPUT);
        });

        lucide.createIcons();
        checkSession();

    </script>
</body>
</html>
